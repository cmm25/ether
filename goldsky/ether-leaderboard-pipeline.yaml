# goldsky/ether-leaderboard-pipeline.yaml
name: ether-leaderboard-pipeline
apiVersion: 3
resource_size: s

sources:
  # Use the vote data from previous pipeline
  live_votes:
    dataset_name: ethereum.logs
    version: 1.0.0
    type: dataset
    start_at: latest

transforms:
  # Real-time leaderboard calculation
  live_leaderboard:
    sql: |
      SELECT
        campaign_id,
        submission_id,
        COUNT(*) as vote_count,
        COUNT(DISTINCT voter_address) as unique_voters,
        -- Calculate ranking within campaign
        ROW_NUMBER() OVER (
          PARTITION BY campaign_id
          ORDER BY COUNT(*) DESC, MIN(block_timestamp) ASC
        ) as current_rank,
        -- Determine if this submission is in top N (winners)
        CASE
          WHEN ROW_NUMBER() OVER (
            PARTITION BY campaign_id
            ORDER BY COUNT(*) DESC, MIN(block_timestamp) ASC
          ) <= 5 THEN true
          ELSE false
        END as is_current_winner,
        MAX(block_timestamp) as last_updated,
        CONCAT(campaign_id, '_leaderboard') as leaderboard_key
      FROM (
        SELECT
          CAST(CONV(SUBSTRING(topics[1], 3), 16, 10) AS STRING) as campaign_id,
          CAST(CONV(SUBSTRING(topics[2], 3), 16, 10) AS STRING) as submission_id,
          CONCAT('0x', SUBSTRING(topics[3], 27)) as voter_address,
          block_timestamp
        FROM live_votes
        WHERE address = '0xYOUR_VOTING_CONTRACT_ADDRESS'
          AND topics[0] = '0xVOTE_EVENT_SIGNATURE_HASH'
      ) vote_data
      GROUP BY campaign_id, submission_id
    primary_key: leaderboard_key

  # Campaign winner detection logic
  winner_detection:
    sql: |
      SELECT
        campaign_id,
        submission_id,
        vote_count,
        current_rank,
        -- Flag when a submission becomes/stops being a winner
        CASE
          WHEN current_rank <= 5 AND LAG(current_rank, 1, 999) OVER (
            PARTITION BY campaign_id, submission_id
            ORDER BY last_updated
          ) > 5 THEN 'became_winner'
          WHEN current_rank > 5 AND LAG(current_rank, 1, 999) OVER (
            PARTITION BY campaign_id, submission_id
            ORDER BY last_updated
          ) <= 5 THEN 'lost_winner_status'
          ELSE 'no_change'
        END as winner_status_change,
        last_updated,
        CONCAT(campaign_id, '_', submission_id, '_status') as status_key
      FROM live_leaderboard
      WHERE winner_status_change != 'no_change'
    primary_key: status_key

sinks:
  # Real-time leaderboard for frontend
  leaderboard_sink:
    type: hosted_postgres
    table: live_leaderboard
    schema: ether_live
    from: live_leaderboard

  # Winner status changes for notifications
  winner_status_sink:
    type: hosted_postgres
    table: winner_status_changes
    schema: ether_live
    from: winner_detection