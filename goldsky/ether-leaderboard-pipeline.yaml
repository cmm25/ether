name: ether-leaderboard-pipeline
apiVersion: 3
resource_size: s

sources:
  live_votes:
    dataset_name: ethereum_sepolia.raw_logs
    version: 1.0.0
    type: dataset
    start_at: latest

transforms:
  # Simplified vote storage without parsing
  vote_events:
    sql: |
      SELECT
        transaction_hash,
        address as voting_contract,
        topics,
        block_number,
        block_timestamp,
        log_index,
        CONCAT(address, '_', CAST(block_number AS STRING), '_', CAST(log_index AS STRING)) as event_key
      FROM live_votes
      WHERE address = '0xD84125E5691da5C11d918552F4fC5B8835D074F3'
        AND topics LIKE '0xf6ed5a0362706e33942c258dd867d1664e91a7653843a7c3459a857db97287ae%'
    primary_key: event_key

sinks:
  # Store raw vote events
  vote_events_sink:
    type: postgres
    table: vote_events
    schema: ether_live
    from: vote_events
    secret_name: HOSTED_POSTGRES_CMDWV3QIO0