name: ether-core-pipeline
apiVersion: 3
resource_size: s

sources:
  ethereum_nft_transfers:
    dataset_name: ethereum_sepolia.erc721_transfers
    version: 1.2.0
    type: dataset
    start_at: earliest

  ethereum_logs:
    dataset_name: ethereum_sepolia.raw_logs
    version: 1.0.0
    type: dataset
    start_at: earliest
    filter: address IN ('0x2B56e4bb5B885C5B570653491bcb7E69a888C913', '0xF55843733EBF4d8355DF198F99B1b01620C9eD9B', '0x929b94e6Df14F6E91a290c0778feA81b4F26d358')

transforms:
  campaign_nft_mints:
    sql: |
      SELECT
        transaction_hash,
        sender,
        recipient as winner_address,
        address as nft_contract,
        token_id,
        block_number,
        block_timestamp
      FROM ethereum_nft_transfers
      WHERE sender = '0x0000000000000000000000000000000000000000'
        AND address = '0x4d3B0C614DE9830BE97d6B23c74d8356A5CcDd89'
    primary_key: transaction_hash

  campaign_votes:
    sql: |
      SELECT
        transaction_hash,
        address as voting_contract,
        topics,
        block_number,
        block_timestamp,
        log_index,
        CONCAT(transaction_hash, '_', CAST(log_index AS STRING)) as vote_id
      FROM ethereum_logs
      WHERE address = '0x2B56e4bb5B885C5B570653491bcb7E69a888C913'
    primary_key: vote_id

  campaign_lifecycle:
    sql: |
      SELECT
        transaction_hash,
        address as campaign_contract,
        topics,
        block_number,
        block_timestamp,
        log_index,
        CONCAT(transaction_hash, '_', CAST(log_index AS STRING)) as lifecycle_id
      FROM ethereum_logs
      WHERE address = '0xF55843733EBF4d8355DF198F99B1b01620C9eD9B'
    primary_key: lifecycle_id

  artwork_submissions:
    sql: |
      SELECT
        transaction_hash,
        address as submission_contract,
        topics,
        block_number,
        block_timestamp,
        log_index,
        CONCAT(transaction_hash, '_', CAST(log_index AS STRING)) as submission_id
      FROM ethereum_logs
      WHERE address = '0x929b94e6Df14F6E91a290c0778feA81b4F26d358'
    primary_key: submission_id

sinks:
  nft_mints_sink:
    type: postgres
    table: campaign_nft_mints
    schema: ether_live
    from: campaign_nft_mints
    secret_name: HOSTED_POSTGRES_CMDWV3QIO0

  votes_sink:
    type: postgres
    table: campaign_votes
    schema: ether_live
    from: campaign_votes
    secret_name: HOSTED_POSTGRES_CMDWV3QIO0

  campaign_events_sink:
    type: postgres
    table: campaign_lifecycle
    schema: ether_live
    from: campaign_lifecycle
    secret_name: HOSTED_POSTGRES_CMDWV3QIO0

  submissions_sink:
    type: postgres
    table: artwork_submissions
    schema: ether_live
    from: artwork_submissions
    secret_name: HOSTED_POSTGRES_CMDWV3QIO0